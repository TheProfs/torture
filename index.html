<!DOCTYPE html>
  <html>
  <head>
    <title>Torture</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.slim.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.3/Chart.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
      }

      form {
        position: absolute;
        top: 0;
        min-width: 280px;
        padding: 0.5em 1em;
        background: white;
        box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
      }

      input {
        display: block;
        width: 100%;
      }
    </style>
  </head>

  <body>
    <form onsubmit="return false;">
      <p>URL:</p>
      <input
        id="urlInput"
        type="text"
        name="url"
        value="https://experiments.bitpaper.io/paper/test-1">
      <p>Concurrent Requests:</p>
      <input
        id="concRequestsInput"
        type="number"
        min="1"
        max="500"
        value="5"
        name="concurrentrequests">
      <br>
      <br>
      <button onclick="requestStart()"> Start Test </button>
    </form>
    <canvas id="chartCanvas" width="400" height="200"></canvas>
  </body>

  <script>
    const canvas = document.getElementById('chartCanvas')
    const barChart = Chart.Bar(canvas,{
    	data: {
          labels: [],
          datasets: [
            {
              label: "Chunks Received",
              backgroundColor: "rgba(255,99,132,0.2)",
              borderColor: "rgba(255,99,132,1)",
              borderWidth: 2,
              hoverBackgroundColor: "rgba(255,99,132,0.4)",
              hoverBorderColor: "rgba(255,99,132,1)",
              data: []
            }
          ]
      },
      options: {
        scales: {
          yAxes:[{
              stacked:true,
              gridLines: {
                display:true,
                color:"rgba(255,99,132,0.2)"
              }
          }],
          xAxes:[{
              gridLines: {
                display:false
              }
          }]
        }
      }
    })

    const requestStart = () => {
      const url = document.querySelector("#urlInput").value
      const concrequests = document.querySelector("#concRequestsInput").value

      fetch(`${window.location.protocol}//${window.location.host}/start?url=${url}&concrequests=${concrequests}`)
        .then(() => {
          console.info('test started...')
        })
        .catch(err => {
          console.error(err)
        })
    }

    const socket = io(`${window.location.protocol}//${window.location.host}`, {
      transports: ['websocket']
    })

    socket.on('data', data => {
      const i = barChart.data.labels.indexOf(`Request: ${data.request}`)

      if (i > -1) {
        barChart.data.datasets[0].data[i] = data.count
        barChart.update()
        return
      }

      barChart.data.labels.push(`Request: ${data.request}`)
      barChart.data.datasets[0].data.push(data.count)

      barChart.update()
    })
  </script>
</html>
